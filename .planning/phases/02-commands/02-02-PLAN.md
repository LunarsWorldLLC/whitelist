---
phase: 02-commands
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/main/kotlin/com/cocahonka/comfywhitelist/commands/CommandHandler.kt
  - src/main/kotlin/com/cocahonka/comfywhitelist/commands/CommandTabCompleter.kt
  - src/main/kotlin/com/cocahonka/comfywhitelist/storage/YamlStorage.kt
  - src/main/resources/plugin.yml
  - src/main/kotlin/com/cocahonka/comfywhitelist/commands/sub/EnableCommand.kt
  - src/main/kotlin/com/cocahonka/comfywhitelist/commands/sub/DisableCommand.kt
  - src/main/kotlin/com/cocahonka/comfywhitelist/commands/sub/StatusCommand.kt
  - src/main/kotlin/com/cocahonka/comfywhitelist/commands/sub/ClearCommand.kt
  - src/main/kotlin/com/cocahonka/comfywhitelist/commands/sub/ReloadCommand.kt
  - src/main/kotlin/com/cocahonka/comfywhitelist/commands/sub/HelpCommand.kt
autonomous: true

must_haves:
  truths:
    - "Only add, remove, list, check commands are available"
    - "Tab completion works for check command (suggests whitelisted players)"
    - "Old commands are removed from codebase"
    - "Permissions updated to match available commands"
  artifacts:
    - path: "src/main/kotlin/com/cocahonka/comfywhitelist/commands/CommandHandler.kt"
      provides: "Simplified command registration"
      contains: "CheckCommand"
    - path: "src/main/resources/plugin.yml"
      provides: "Updated permissions"
      contains: "comfywhitelist.check"
  key_links:
    - from: "CommandHandler.kt"
      to: "CheckCommand"
      via: "command registration in init"
      pattern: "CheckCommand\\(storage\\)"
    - from: "CommandTabCompleter.kt"
      to: "CheckCommand"
      via: "tab completion case"
      pattern: "check.*->.*whitelistedPlayers"
---

<objective>
Clean up unused commands and integrate CheckCommand into command system

Purpose: Remove 6 unused commands (SIM-02), update command registration and tab completion
Output: Simplified command system with only add, remove, list, check commands
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-commands/02-RESEARCH.md
@.planning/phases/02-commands/02-01-SUMMARY.md

# Files to modify
@src/main/kotlin/com/cocahonka/comfywhitelist/commands/CommandHandler.kt
@src/main/kotlin/com/cocahonka/comfywhitelist/commands/CommandTabCompleter.kt
@src/main/resources/plugin.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update CommandHandler and CommandTabCompleter</name>
  <files>
    src/main/kotlin/com/cocahonka/comfywhitelist/commands/CommandHandler.kt
    src/main/kotlin/com/cocahonka/comfywhitelist/commands/CommandTabCompleter.kt
    src/main/kotlin/com/cocahonka/comfywhitelist/storage/YamlStorage.kt
  </files>
  <action>
    1. Modify CommandHandler.kt:
       - Change storage parameter type from `Storage` to `YamlStorage`
       - Remove imports for deleted commands (EnableCommand, DisableCommand, StatusCommand, ClearCommand, ReloadCommand, HelpCommand)
       - Remove generalConfig and plugin constructor parameters (no longer needed)
       - In init block, keep only 4 commands:
         ```kotlin
         val commands = listOf(
             AddCommand(storage),
             RemoveCommand(storage),
             ListCommand(storage),
             CheckCommand(storage),
         )
         subCommands = commands
         ```
       - Remove HelpCommand wrapping logic

    2. Modify CommandTabCompleter.kt:
       - Change storage parameter type from `Storage` to `YamlStorage`
       - Add import for CheckCommand
       - In onTabComplete, update the when block to include check:
         ```kotlin
         val addCommand = subCommands.find { it is AddCommand }
         val removeCommand = subCommands.find { it is RemoveCommand }
         val checkCommand = subCommands.find { it is CheckCommand }
         when (subCommandIdentifier.lowercase()) {
             addCommand?.identifier -> {
                 // online players (existing logic)
             }
             removeCommand?.identifier, checkCommand?.identifier -> {
                 // whitelisted players for both remove and check
             }
         }
         ```

    3. In YamlStorage.kt, add allWhitelistedPlayers property for tab completion:
       - Check if this property already exists (it may be via Storage interface)
       - The tab completer uses storage.allWhitelistedPlayers which maps to getAllWhitelistedPlayers()
       - This should already work, verify the interface provides this
  </action>
  <verify>Project compiles: `cd /home/claude/whitelist && ./gradlew compileKotlin`</verify>
  <done>CommandHandler registers only 4 commands, CommandTabCompleter handles check command tab completion</done>
</task>

<task type="auto">
  <name>Task 2: Delete unused commands and update plugin.yml</name>
  <files>
    src/main/kotlin/com/cocahonka/comfywhitelist/commands/sub/EnableCommand.kt
    src/main/kotlin/com/cocahonka/comfywhitelist/commands/sub/DisableCommand.kt
    src/main/kotlin/com/cocahonka/comfywhitelist/commands/sub/StatusCommand.kt
    src/main/kotlin/com/cocahonka/comfywhitelist/commands/sub/ClearCommand.kt
    src/main/kotlin/com/cocahonka/comfywhitelist/commands/sub/ReloadCommand.kt
    src/main/kotlin/com/cocahonka/comfywhitelist/commands/sub/HelpCommand.kt
    src/main/resources/plugin.yml
  </files>
  <action>
    1. Delete the following command files:
       - EnableCommand.kt
       - DisableCommand.kt
       - StatusCommand.kt
       - ClearCommand.kt
       - ReloadCommand.kt
       - HelpCommand.kt

    2. Update plugin.yml permissions section:
       - Remove: comfywhitelist.clear, comfywhitelist.on, comfywhitelist.off, comfywhitelist.reload, comfywhitelist.help, comfywhitelist.status
       - Add: comfywhitelist.check with description "Give access to check player whitelist status." default: op
       - Update comfywhitelist.* children to only include: add, remove, list, check
       - Update comfywhitelist.remove to not have clear as child (clear no longer exists)

       Final permissions structure:
       ```yaml
       permissions:
         comfywhitelist.*:
           description: Give access to all ComfyWhitelist commands.
           default: op
           children:
             comfywhitelist.add: true
             comfywhitelist.remove: true
             comfywhitelist.list: true
             comfywhitelist.check: true
         comfywhitelist.comfywhitelist:
           description: Give access to main ComfyWhitelist command.
           default: op
         comfywhitelist.add:
           description: Give access to add player name to ComfyWhitelist.
           default: op
         comfywhitelist.remove:
           description: Give access to remove player name from ComfyWhitelist.
           default: op
         comfywhitelist.list:
           description: Give access to display all player names in ComfyWhitelist.
           default: op
         comfywhitelist.check:
           description: Give access to check player whitelist status.
           default: op
       ```
  </action>
  <verify>
    1. Verify deleted files no longer exist: `ls src/main/kotlin/com/cocahonka/comfywhitelist/commands/sub/`
    2. Project compiles: `cd /home/claude/whitelist && ./gradlew compileKotlin`
  </verify>
  <done>6 command files deleted, plugin.yml updated with simplified permissions and check permission added</done>
</task>

<task type="auto">
  <name>Task 3: Delete test files for removed commands</name>
  <files>
    src/test/kotlin/com/cocahonka/comfywhitelist/commands/sub/EnableCommandTest.kt
    src/test/kotlin/com/cocahonka/comfywhitelist/commands/sub/DisableCommandTest.kt
    src/test/kotlin/com/cocahonka/comfywhitelist/commands/sub/StatusCommandTest.kt
    src/test/kotlin/com/cocahonka/comfywhitelist/commands/sub/ClearCommandTest.kt
    src/test/kotlin/com/cocahonka/comfywhitelist/commands/sub/ReloadCommandTest.kt
    src/test/kotlin/com/cocahonka/comfywhitelist/commands/sub/HelpCommandTest.kt
  </files>
  <action>
    1. Check if test files exist for deleted commands:
       `ls src/test/kotlin/com/cocahonka/comfywhitelist/commands/sub/`

    2. Delete any existing test files for the deleted commands:
       - EnableCommandTest.kt (if exists)
       - DisableCommandTest.kt (if exists)
       - StatusCommandTest.kt (if exists)
       - ClearCommandTest.kt (if exists)
       - ReloadCommandTest.kt (if exists)
       - HelpCommandTest.kt (if exists)

    3. Run tests to ensure remaining tests pass:
       `./gradlew test`
  </action>
  <verify>
    1. No test files for deleted commands: `ls src/test/kotlin/com/cocahonka/comfywhitelist/commands/sub/`
    2. Tests pass: `cd /home/claude/whitelist && ./gradlew test`
  </verify>
  <done>Test files for deleted commands removed, remaining tests pass</done>
</task>

</tasks>

<verification>
1. `./gradlew compileKotlin` - project compiles
2. `./gradlew test` - all tests pass
3. Only 4 command files remain in sub/ directory: AddCommand, RemoveCommand, ListCommand, CheckCommand
4. plugin.yml has check permission, removed old permissions
5. CommandHandler only registers 4 commands
6. Tab completion works for check (suggests whitelisted players)
</verification>

<success_criteria>
- EnableCommand, DisableCommand, StatusCommand, ClearCommand, ReloadCommand, HelpCommand deleted
- CommandHandler registers only add, remove, list, check
- CommandTabCompleter suggests whitelisted players for check command
- plugin.yml has comfywhitelist.check permission
- plugin.yml removed clear, on, off, reload, help, status permissions
- All tests pass
- Project compiles and builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/02-commands/02-02-SUMMARY.md`
</output>
