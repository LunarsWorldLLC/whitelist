---
phase: 02-commands
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/kotlin/com/cocahonka/comfywhitelist/storage/YamlStorage.kt
  - src/main/kotlin/com/cocahonka/comfywhitelist/config/message/Messages.kt
  - src/main/kotlin/com/cocahonka/comfywhitelist/config/message/MessageFormat.kt
  - src/main/kotlin/com/cocahonka/comfywhitelist/commands/sub/AddCommand.kt
  - src/main/kotlin/com/cocahonka/comfywhitelist/commands/sub/ListCommand.kt
  - src/main/kotlin/com/cocahonka/comfywhitelist/commands/sub/RemoveCommand.kt
  - src/main/kotlin/com/cocahonka/comfywhitelist/commands/sub/CheckCommand.kt
autonomous: true

must_haves:
  truths:
    - "Add command creates player with 31-day expiry"
    - "Add command on existing player extends expiry by 31 days from now"
    - "List command shows player names with days remaining"
    - "Check command shows specific player remaining time or not found"
  artifacts:
    - path: "src/main/kotlin/com/cocahonka/comfywhitelist/commands/sub/CheckCommand.kt"
      provides: "Check command implementation"
      min_lines: 30
    - path: "src/main/kotlin/com/cocahonka/comfywhitelist/config/message/Messages.kt"
      provides: "New messages for extend and check"
      contains: "playerExpiryExtended"
  key_links:
    - from: "AddCommand.kt"
      to: "YamlStorage.addPlayerWithExpiry"
      via: "storage call with 31-day timestamp"
      pattern: "addPlayerWithExpiry.*EXPIRY_DAYS.*MILLIS_PER_DAY"
    - from: "ListCommand.kt"
      to: "YamlStorage.getAllValidEntries"
      via: "storage call for entries with expiry"
      pattern: "getAllValidEntries"
    - from: "CheckCommand.kt"
      to: "YamlStorage.getEntry"
      via: "storage lookup by name"
      pattern: "storage\\.getEntry"
---

<objective>
Implement expiry-aware command logic and create new CheckCommand

Purpose: Enable add/list/check commands to work with 31-day expiry timestamps
Output: Modified add/list commands with expiry logic, new check command, supporting messages
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-commands/02-RESEARCH.md

# Existing code to understand
@src/main/kotlin/com/cocahonka/comfywhitelist/storage/YamlStorage.kt
@src/main/kotlin/com/cocahonka/comfywhitelist/storage/WhitelistEntry.kt
@src/main/kotlin/com/cocahonka/comfywhitelist/commands/sub/AddCommand.kt
@src/main/kotlin/com/cocahonka/comfywhitelist/commands/sub/ListCommand.kt
@src/main/kotlin/com/cocahonka/comfywhitelist/commands/sub/RemoveCommand.kt
@src/main/kotlin/com/cocahonka/comfywhitelist/config/message/Messages.kt
@src/main/kotlin/com/cocahonka/comfywhitelist/config/message/MessageFormat.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add storage method and message infrastructure</name>
  <files>
    src/main/kotlin/com/cocahonka/comfywhitelist/storage/YamlStorage.kt
    src/main/kotlin/com/cocahonka/comfywhitelist/config/message/Messages.kt
    src/main/kotlin/com/cocahonka/comfywhitelist/config/message/MessageFormat.kt
  </files>
  <action>
    1. In YamlStorage.kt, add method to get all valid entries:
       ```kotlin
       fun getAllValidEntries(): List<WhitelistEntry> {
           return whitelistedPlayers.values.filter { it.isValid() }
       }
       ```

    2. In Messages.kt, add two new messages:
       ```kotlin
       val playerExpiryExtended: Component = styled("<comfy>Player <success><name></success> whitelist <success>extended</success> by 31 days.")
       val playerCheckResult: Component = styled("<comfy>Player <success><name></success> has <success><days></success> remaining.")
       ```

    3. In MessageFormat.kt ConfigBuilders object, add days replacement builder:
       ```kotlin
       val daysReplacementConfigBuilder = { days: String ->
           TextReplacementConfig.builder()
               .match("<days>")
               .replacement(days)
               .build()
       }
       ```
  </action>
  <verify>Project compiles: `cd /home/claude/whitelist && ./gradlew compileKotlin`</verify>
  <done>YamlStorage has getAllValidEntries(), Messages has playerExpiryExtended and playerCheckResult, MessageFormat has daysReplacementConfigBuilder</done>
</task>

<task type="auto">
  <name>Task 2: Modify commands and create CheckCommand</name>
  <files>
    src/main/kotlin/com/cocahonka/comfywhitelist/commands/sub/AddCommand.kt
    src/main/kotlin/com/cocahonka/comfywhitelist/commands/sub/ListCommand.kt
    src/main/kotlin/com/cocahonka/comfywhitelist/commands/sub/RemoveCommand.kt
    src/main/kotlin/com/cocahonka/comfywhitelist/commands/sub/CheckCommand.kt
  </files>
  <action>
    1. Modify AddCommand.kt:
       - Change constructor to take `YamlStorage` instead of `Storage`
       - Add companion object constants: `EXPIRY_DAYS = 31L`, `MILLIS_PER_DAY = 24L * 60L * 60L * 1000L`
       - In execute(): calculate `newExpiry = System.currentTimeMillis() + (EXPIRY_DAYS * MILLIS_PER_DAY)`
       - Check if player exists with `storage.getEntry(playerName)`
       - If exists and isValid(), use `Messages.playerExpiryExtended` message
       - If not exists or expired, use `Messages.playerAdded` message
       - Call `storage.addPlayerWithExpiry(playerName, newExpiry)` instead of `addPlayer()`

    2. Modify ListCommand.kt:
       - Change constructor to take `YamlStorage` instead of `Storage`
       - In execute(): call `storage.getAllValidEntries()` instead of `allWhitelistedPlayers`
       - Add private helper function `formatDaysRemaining(entry: WhitelistEntry): String`:
         - If isPermanent() return "permanent"
         - Get remainingTimeMillis, if null or <= 0 return "0 days"
         - Calculate days = remainingMillis / (24 * 60 * 60 * 1000)
         - Return "${days} days" (or "1 day" for singular)
       - Map entries to format: "${entry.playerName} (${formatDaysRemaining(entry)} remaining)"
       - Convert to Set<String> and pass to playersReplacementConfigBuilder

    3. Modify RemoveCommand.kt:
       - Change constructor to take `YamlStorage` instead of `Storage` (for consistency)

    4. Create CheckCommand.kt following existing command patterns:
       - Package: com.cocahonka.comfywhitelist.commands.sub
       - Constructor takes YamlStorage
       - identifier = "check", permission = "comfywhitelist.check", usage = "/comfywl check <name>"
       - In execute():
         - Validate args.size == 1
         - Validate playerName against SubCommand.playerNameRegex
         - Call storage.getEntry(playerName)
         - If null or !isValid(), send Messages.nonExistentPlayerName with name replacement
         - If valid, calculate days remaining using same formatDaysRemaining logic
         - Send Messages.playerCheckResult with both name and days replacements
  </action>
  <verify>Project compiles: `cd /home/claude/whitelist && ./gradlew compileKotlin`</verify>
  <done>AddCommand uses 31-day expiry and extends, ListCommand shows days remaining, CheckCommand created, RemoveCommand uses YamlStorage</done>
</task>

</tasks>

<verification>
1. `./gradlew compileKotlin` - all source compiles
2. Verify AddCommand has EXPIRY_DAYS constant and calls addPlayerWithExpiry
3. Verify ListCommand calls getAllValidEntries and formats with days remaining
4. Verify CheckCommand exists with check identifier and proper permission
5. Verify new messages exist in Messages.kt
</verification>

<success_criteria>
- AddCommand creates entries with 31-day expiry timestamp
- AddCommand extends existing valid entries (sends extended message)
- ListCommand displays "PlayerName (X days remaining)" format
- ListCommand shows "permanent" for null-expiry entries
- CheckCommand shows specific player's remaining time
- CheckCommand shows "not found" for missing/expired players
- All commands use YamlStorage type
- Project compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-commands/02-01-SUMMARY.md`
</output>
