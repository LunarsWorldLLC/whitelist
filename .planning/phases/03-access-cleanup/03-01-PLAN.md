---
phase: 03-access-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/test/kotlin/com/cocahonka/comfywhitelist/listeners/PlayerPreLoginEventTest.kt
  - src/main/kotlin/com/cocahonka/comfywhitelist/storage/YamlStorage.kt
  - src/main/kotlin/com/cocahonka/comfywhitelist/tasks/ExpiredEntriesCleanupTask.kt
  - src/test/kotlin/com/cocahonka/comfywhitelist/tasks/ExpiredEntriesCleanupTaskTest.kt
  - src/main/kotlin/com/cocahonka/comfywhitelist/config/general/GeneralConfig.kt
  - src/main/resources/config.yml
  - src/main/kotlin/com/cocahonka/comfywhitelist/ComfyWhitelist.kt
autonomous: true

must_haves:
  truths:
    - "Non-whitelisted players cannot join server"
    - "Players with expired entries cannot join server"
    - "Players with valid (non-expired) entries can join server"
    - "Expired entries are automatically removed from storage"
    - "Cleanup task runs at configurable interval"
  artifacts:
    - path: "src/test/kotlin/com/cocahonka/comfywhitelist/listeners/PlayerPreLoginEventTest.kt"
      provides: "Tests verifying expiry-aware access control"
      contains: "expired player is blocked"
    - path: "src/main/kotlin/com/cocahonka/comfywhitelist/storage/YamlStorage.kt"
      provides: "removeExpiredEntries method"
      contains: "fun removeExpiredEntries"
    - path: "src/main/kotlin/com/cocahonka/comfywhitelist/tasks/ExpiredEntriesCleanupTask.kt"
      provides: "Scheduled cleanup task"
      contains: "class ExpiredEntriesCleanupTask"
    - path: "src/main/kotlin/com/cocahonka/comfywhitelist/config/general/GeneralConfig.kt"
      provides: "Cleanup interval config"
      contains: "cleanupIntervalHours"
  key_links:
    - from: "src/main/kotlin/com/cocahonka/comfywhitelist/ComfyWhitelist.kt"
      to: "ExpiredEntriesCleanupTask"
      via: "runTaskTimer in onPluginEnable"
      pattern: "runTaskTimer"
    - from: "src/main/kotlin/com/cocahonka/comfywhitelist/tasks/ExpiredEntriesCleanupTask.kt"
      to: "YamlStorage.removeExpiredEntries"
      via: "run method calling storage"
      pattern: "storage\\.removeExpiredEntries"
---

<objective>
Complete Phase 3: Verify access control and implement expired entry cleanup

Purpose: Ensure non-whitelisted and expired players are blocked, and expired entries are automatically cleaned from storage. Access control is already implemented - this plan verifies it works and adds the cleanup task.

Output: Tests confirming expiry-aware access control, cleanup task that removes expired entries on schedule, fully functional plugin end-to-end.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-access-cleanup/03-RESEARCH.md

# Key source files
@src/main/kotlin/com/cocahonka/comfywhitelist/listeners/PlayerPreLoginEvent.kt
@src/main/kotlin/com/cocahonka/comfywhitelist/storage/YamlStorage.kt
@src/main/kotlin/com/cocahonka/comfywhitelist/ComfyWhitelist.kt
@src/main/kotlin/com/cocahonka/comfywhitelist/config/general/GeneralConfig.kt
@src/test/kotlin/com/cocahonka/comfywhitelist/listeners/PlayerPreLoginEventTest.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify expiry-aware access control with tests</name>
  <files>src/test/kotlin/com/cocahonka/comfywhitelist/listeners/PlayerPreLoginEventTest.kt</files>
  <action>
Add tests to PlayerPreLoginEventTest.kt that verify the EXISTING access control handles expiry correctly:

1. Add test `when player has EXPIRED entry, whitelist is ON`:
   - Enable whitelist
   - Cast storage to YamlStorage and call addPlayerWithExpiry with timestamp in the past (System.currentTimeMillis() - 1000L)
   - Execute event
   - Assert KICK_WHITELIST result (blocked)

2. Add test `when player has VALID timed entry, whitelist is ON`:
   - Enable whitelist
   - Cast storage to YamlStorage and call addPlayerWithExpiry with timestamp in the future (+86400000L = 1 day)
   - Execute event
   - Assert ALLOWED result (permitted)

3. Add test `when player has PERMANENT entry, whitelist is ON`:
   - Enable whitelist
   - Cast storage to YamlStorage and call addPlayerWithExpiry with null expiry
   - Execute event
   - Assert ALLOWED result (permitted)

These tests verify ACC-01 and ACC-02 requirements using the existing implementation. The listener already calls storage.isPlayerWhitelisted() which checks entry.isValid() including expiry.
  </action>
  <verify>Run `./gradlew test --tests "PlayerPreLoginEventTest"` - all 7 tests pass (4 existing + 3 new)</verify>
  <done>Tests confirm: expired entries blocked, valid timed entries allowed, permanent entries allowed</done>
</task>

<task type="auto">
  <name>Task 2: Implement cleanup task and storage method</name>
  <files>
    src/main/kotlin/com/cocahonka/comfywhitelist/storage/YamlStorage.kt
    src/main/kotlin/com/cocahonka/comfywhitelist/tasks/ExpiredEntriesCleanupTask.kt
    src/test/kotlin/com/cocahonka/comfywhitelist/tasks/ExpiredEntriesCleanupTaskTest.kt
  </files>
  <action>
1. Add removeExpiredEntries() to YamlStorage.kt:
```kotlin
/**
 * Removes all expired entries from storage and saves.
 *
 * @return Number of entries removed
 */
fun removeExpiredEntries(): Int {
    val expiredKeys = whitelistedPlayers.entries
        .filter { !it.value.isValid() }
        .map { it.key }

    if (expiredKeys.isEmpty()) return 0

    expiredKeys.forEach { whitelistedPlayers.remove(it) }
    save()
    return expiredKeys.size
}
```

2. Create tasks/ directory and ExpiredEntriesCleanupTask.kt:
```kotlin
package com.cocahonka.comfywhitelist.tasks

import com.cocahonka.comfywhitelist.storage.YamlStorage
import org.bukkit.plugin.java.JavaPlugin
import org.bukkit.scheduler.BukkitRunnable

class ExpiredEntriesCleanupTask(
    private val storage: YamlStorage,
    private val plugin: JavaPlugin
) : BukkitRunnable() {

    override fun run() {
        val removedCount = storage.removeExpiredEntries()
        if (removedCount > 0) {
            plugin.logger.info("Removed $removedCount expired whitelist entries")
        }
    }
}
```

3. Create test file ExpiredEntriesCleanupTaskTest.kt with tests:
- Test removeExpiredEntries removes expired but keeps valid entries
- Test removeExpiredEntries returns correct count
- Test removeExpiredEntries saves to file (reload and verify)
- Test with no expired entries returns 0

Follow existing test patterns from storage/YamlStorageTest.kt.
  </action>
  <verify>Run `./gradlew test --tests "ExpiredEntriesCleanupTaskTest"` - all tests pass</verify>
  <done>YamlStorage has removeExpiredEntries() method, cleanup task class exists, tests verify CLN-01 and CLN-02</done>
</task>

<task type="auto">
  <name>Task 3: Wire cleanup task into plugin lifecycle with config</name>
  <files>
    src/main/kotlin/com/cocahonka/comfywhitelist/config/general/GeneralConfig.kt
    src/main/resources/config.yml
    src/main/kotlin/com/cocahonka/comfywhitelist/ComfyWhitelist.kt
  </files>
  <action>
1. Add cleanup interval config to GeneralConfig.kt:
   - Add companion property: `var cleanupIntervalHours: Int by Delegates.notNull()` with private set
   - Add constant: `private const val cleanupIntervalKey = "cleanup-interval-hours"`
   - In updateProperties(): `cleanupIntervalHours = config.getInt(cleanupIntervalKey, 1).coerceAtLeast(1)`

2. Update config.yml - add after clear-command block:
```yaml

# Interval in hours between cleanup task runs (removes expired whitelist entries)
# Minimum: 1 hour
cleanup-interval-hours: 1
```

3. Update ComfyWhitelist.kt:
   - Import BukkitTask and ExpiredEntriesCleanupTask
   - Add private property: `private var cleanupTask: BukkitTask? = null`
   - Create private method startCleanupTask():
     ```kotlin
     private fun startCleanupTask() {
         val intervalTicks = GeneralConfig.cleanupIntervalHours * 20L * 60L * 60L
         cleanupTask = ExpiredEntriesCleanupTask(storage, this)
             .runTaskTimer(this, intervalTicks, intervalTicks)
     }
     ```
   - Call startCleanupTask() at end of onPluginEnable() (after registerCommands)
   - Update onDisable() to cancel task: `cleanupTask?.cancel()`
  </action>
  <verify>Run `./gradlew build` - builds without errors. Manually verify config.yml includes new setting.</verify>
  <done>Cleanup task starts on plugin enable, cancels on disable, interval is configurable via config.yml</done>
</task>

</tasks>

<verification>
1. All tests pass: `./gradlew test`
2. Build succeeds: `./gradlew build`
3. Requirements verified:
   - ACC-01: Test "when ISN'T whitelisted, whitelist is ON" passes (existing)
   - ACC-02: Tests for expired/valid/permanent entries pass (new)
   - CLN-01: ExpiredEntriesCleanupTask exists and is scheduled
   - CLN-02: removeExpiredEntries() removes and saves
</verification>

<success_criteria>
1. All existing tests still pass
2. New access control tests verify expiry handling
3. removeExpiredEntries() removes expired entries and saves
4. Cleanup task is scheduled on plugin enable
5. Cleanup task is canceled on plugin disable
6. Cleanup interval is configurable (default 1 hour)
7. Build produces working JAR
</success_criteria>

<output>
After completion, create `.planning/phases/03-access-cleanup/03-01-SUMMARY.md`
</output>
